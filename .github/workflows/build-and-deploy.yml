name: Build & Deploy

on:
  push:
    branches: [main]
    paths:
      - '**/moonbit/**'
      - '**/cpp/CMakeLists.txt'
      - 'scripts/**'
      - '.github/workflows/build-and-deploy.yml'
  workflow_dispatch:
    inputs:
      projects:
        description: 'Space-separated project names to build (leave empty for all)'
        required: false
        default: ''

concurrency:
  group: build-and-deploy
  cancel-in-progress: true

jobs:
  # ── Job 1: Build all games in parallel chunks ──────────────────────────────
  build:
    name: Build (${{ matrix.chunk }})
    runs-on: self-hosted
    strategy:
      fail-fast: false
      matrix:
        include:
          - chunk: A-F
            pattern: 'RaylibA* RaylibB* RaylibBattleCity RaylibBomberman1983Lite RaylibC* RaylibContra1987Lite RaylibD* RaylibE* RaylibF* RaylibFighter97Lite'
          - chunk: G-M
            pattern: 'RaylibG* RaylibH* RaylibI* RaylibJ* RaylibJackal1988Lite RaylibK* RaylibL* RaylibM* RaylibMinesweeper'
          - chunk: N-Z
            pattern: 'RaylibN* RaylibO* RaylibP* RaylibQ* RaylibR* RaylibS* RaylibSuperMario1985Lite RaylibT* RaylibU* RaylibV* RaylibW* RaylibX* RaylibY* RaylibZ*'

    steps:
      - uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Install MoonBit
        run: |
          if ! command -v moon &>/dev/null; then
            curl -fsSL https://cli.moonbitlang.com/install/unix.sh | bash
            echo "$HOME/.moon/bin" >> "$GITHUB_PATH"
          fi
          moon version

      - name: Install Android NDK ${{ env.NDK_VERSION }}
        env:
          NDK_VERSION: 28.2.13676358
        run: |
          sdkmanager "ndk;${NDK_VERSION}"

      - name: Build projects
        env:
          ANDROID_HOME: ${{ env.ANDROID_SDK_ROOT }}
          MAX_PARALLEL: '4'
        run: |
          if [[ -n "${{ github.event.inputs.projects }}" ]]; then
            bash scripts/build_games.sh ${{ github.event.inputs.projects }}
          else
            # Expand the glob pattern for this chunk
            cd "$GITHUB_WORKSPACE"
            PROJECTS=()
            for pat in ${{ matrix.pattern }}; do
              for d in $pat; do
                [[ -f "${d}/gradlew" ]] && PROJECTS+=("$(basename $d)")
              done
            done
            bash scripts/build_games.sh "${PROJECTS[@]}"
          fi

      - name: Collect APKs
        run: |
          mkdir -p /tmp/apks
          find . -maxdepth 5 -name "app-debug.apk" -path "*/outputs/apk/debug/*" | \
          while read apk; do
            proj=$(echo "$apk" | cut -d/ -f2)
            cp "$apk" "/tmp/apks/${proj}.apk"
          done
          ls /tmp/apks/ | wc -l

      - name: Upload APK artifacts
        uses: actions/upload-artifact@v4
        with:
          name: apks-${{ matrix.chunk }}
          path: /tmp/apks/*.apk
          retention-days: 1

      - name: Upload build logs on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: build-logs-${{ matrix.chunk }}
          path: build_logs/
          retention-days: 3

  # ── Job 2: Upload APKs to S3 + regenerate GitHub Pages ────────────────────
  deploy:
    name: Deploy
    needs: build
    runs-on: self-hosted
    permissions:
      contents: write

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0   # needed to push gh-pages

      - name: Download all APK artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: apks-*
          path: /tmp/apks
          merge-multiple: true

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: us-west-2

      - name: Upload APKs to S3
        env:
          S3_BUCKET: moonbit-raylib-android-games
          AWS_REGION: us-west-2
        run: |
          for apk in /tmp/apks/*.apk; do
            name=$(basename "$apk")
            echo "Uploading $name ..."
            aws s3 cp "$apk" "s3://${S3_BUCKET}/${name}" \
              --region "${AWS_REGION}" \
              --content-type "application/vnd.android.package-archive" \
              --no-progress
          done
          echo "Uploaded $(ls /tmp/apks/*.apk | wc -l) APKs."

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Generate site
        env:
          S3_BUCKET: moonbit-raylib-android-games
          AWS_REGION: us-west-2
          OUTPUT_DIR: docs
        run: python3 scripts/generate_site.py

      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./docs
          publish_branch: gh-pages
          commit_message: 'Deploy: update site [${{ github.sha }}]'
